@page "/ventas/detalles/{Id:int}"
@using GestionDespensa1.Shared.DTO
@using GestionDespensa1.Client.Servicios.Entidades
@inject IVentaService VentaService
@inject IClienteService ClienteService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>Detalles de Venta - GestionDespensa</PageTitle>

<div class="container-fluid py-4">
    <!-- Botón de volver -->
    <div class="mb-4">
        <button class="btn btn-outline-secondary mb-3" @onclick="VolverALista">
            <i class="bi bi-arrow-left me-1"></i> Volver a Lista
        </button>
    </div>

    @if (cargando)
    {
        <div class="alert alert-info text-center">
            <i class="bi bi-arrow-repeat spinner me-2"></i>Cargando detalles...
        </div>
    }
    else if (venta == null)
    {
        <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>Venta no encontrada
        </div>
    }
    else
    {
        <!-- Encabezado -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="mb-0">
                <i class="bi bi-eye text-info me-2"></i>Detalles de Venta #@venta.Id
            </h3>
            <div>
                <button class="btn btn-warning me-2" @onclick="IrAEditar">
                    <i class="bi bi-pencil me-1"></i> Editar Venta
                </button>
                @if (venta.SaldoPendiente > 0)
                {
                    <button class="btn btn-success me-2" @onclick="SaldarVenta">
                        <i class="bi bi-credit-card me-1"></i> Saldar
                    </button>
                }
                <button class="btn btn-danger" @onclick="EliminarVenta">
                    <i class="bi bi-trash me-1"></i> Eliminar
                </button>
            </div>
        </div>

        <!-- Tarjeta de información principal -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-receipt me-2"></i>Información General</h5>
                <span class="badge @GetEstadoBadgeClass(venta.Estado) fs-6">@venta.Estado</span>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th width="40%">ID Venta:</th>
                                <td>#@venta.Id</td>
                            </tr>
                            <tr>
                                <th>Fecha:</th>
                                <td>@venta.FechaVenta.ToString("dd/MM/yyyy HH:mm")</td>
                            </tr>
                            <tr>
                                <th>Cliente:</th>
                                <td>@nombreCliente</td>
                            </tr>
                            <tr>
                                <th>Método Pago:</th>
                                <td><span class="badge bg-secondary">@venta.MetodoPago</span></td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <table class="table table-borderless">
                            <tr>
                                <th width="50%">Total Venta:</th>
                                <td class="text-success fw-bold fs-5">@venta.Total.ToString("C")</td>
                            </tr>
                            <tr>
                                <th>Total Pagado:</th>
                                <td class="text-primary fs-5">@venta.MontoPagado.ToString("C")</td>
                            </tr>
                            <tr>
                                <th>Saldo Pendiente:</th>
                                <td class="@(venta.SaldoPendiente > 0 ? "text-danger fw-bold fs-5" : "text-success fs-5")">
                                    @venta.SaldoPendiente.ToString("C")
                                </td>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tarjeta de productos (solo lectura) -->
        <div class="card mb-4">
            <div class="card-header bg-dark text-white">
                <h5 class="mb-0"><i class="bi bi-cart me-2"></i>Productos Vendidos</h5>
            </div>
            <div class="card-body">
                @if (detallesVenta.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Producto</th>
                                    <th class="text-center">Cantidad</th>
                                    <th class="text-end">Precio Unit.</th>
                                    <th class="text-end">Subtotal</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var detalle in detallesVenta)
                                {
                                    <tr>
                                        <td>@detalle.DescripcionProducto</td>
                                        <td class="text-center">@detalle.Cantidad</td>
                                        <td class="text-end">@detalle.PrecioUnitario.ToString("C")</td>
                                        <td class="text-end fw-bold">
                                            @((detalle.Cantidad * detalle.PrecioUnitario).ToString("C"))
                                        </td>
                                    </tr>
                                }
                            </tbody>
                            <tfoot class="table-light">
                                <tr>
                                    <td colspan="3" class="text-end fw-bold">Total:</td>
                                    <td class="text-end fw-bold fs-5 text-success">
                                        @venta.Total.ToString("C")
                                    </td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning text-center">
                        <i class="bi bi-cart-x me-2"></i>No hay productos registrados en esta venta
                    </div>
                }
            </div>
        </div>

        <!-- Tarjeta de Notas -->
        @if (!string.IsNullOrEmpty(venta.Notas))
        {
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="bi bi-chat-left-text me-2"></i>Notas</h5>
                </div>
                <div class="card-body">
                    <div class="bg-light p-3 rounded" style="white-space: pre-line;">
                        @venta.Notas
                    </div>
                </div>
            </div>
        }
    }
</div>

<style>
    .spinner {
        animation: spin 1s linear infinite;
    }

    .card {
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        border: none;
    }

    .card-header {
        border-radius: 10px 10px 0 0 !important;
    }

    .table th {
        font-weight: 600;
    }

    @@keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }
</style>

@code {
    [Parameter] public int Id { get; set; }

    private VentaDTO? venta;
    private List<DetalleVentaDTO> detallesVenta = new();
    private string nombreCliente = "Cliente no encontrado";
    private bool cargando = true;

    protected override async Task OnInitializedAsync()
    {
        await CargarDetallesVenta();
    }

    private async Task CargarDetallesVenta()
    {
        cargando = true;

        // 1. Cargar venta principal
        var respuestaVenta = await VentaService.Get(Id);
        if (!respuestaVenta.Error && respuestaVenta.Respuesta != null)
        {
            venta = respuestaVenta.Respuesta;

            // 2. Cargar detalles de la venta (si tu VentaDTO ya los trae)
            detallesVenta = venta.DetallesVenta ?? new List<DetalleVentaDTO>();

            // 3. Cargar nombre del cliente
            if (venta.IdCliente > 0)
            {
                var respuestaCliente = await ClienteService.Get(venta.IdCliente);
                if (!respuestaCliente.Error && respuestaCliente.Respuesta != null)
                {
                    var cliente = respuestaCliente.Respuesta;
                    nombreCliente = $"{cliente.Nombre} {cliente.Apellido}".Trim();
                }
            }
            else
            {
                nombreCliente = "Cliente ocasional";
            }
        }

        cargando = false;
    }

    private string GetEstadoBadgeClass(string estado)
    {
        return estado switch
        {
            "Pagado" => "bg-success",
            "Pendiente" => "bg-warning",
            "Cancelado" => "bg-danger",
            "Parcial" => "bg-info",
            _ => "bg-secondary"
        };
    }

    private void VolverALista() => Navigation.NavigateTo("/ventas");

    private void IrAEditar() => Navigation.NavigateTo($"/ventas/editar/{Id}");

    private async Task SaldarVenta()
    {
        if (venta == null || venta.SaldoPendiente <= 0) return;

        var confirmar = await JS.InvokeAsync<bool>("confirm",
            $"¿Saldar completamente la venta #{venta.Id}?\n\n" +
            $"Cliente: {nombreCliente}\n" +
            $"Saldo pendiente: {venta.SaldoPendiente:C}");

        if (!confirmar) return;

        
        // Usar la misma lógica que en la lista de ventas
        var ventaActualizada = new VentaDTO
        {
            Id = venta.Id,
            IdCliente = venta.IdCliente,
            FechaVenta = venta.FechaVenta,
            Estado = "Pagado",
            Total = venta.Total,
            MontoPagado = venta.Total,
            SaldoPendiente = 0,
            MetodoPago = venta.MetodoPago,
            Notas = venta.Notas ?? ""
        };


        var respuesta = await VentaService.Update(Id, ventaActualizada);

        if (!respuesta.Error)
        {
            await JS.InvokeVoidAsync("alert", "✅ Venta saldada");
            await CargarDetallesVenta();
        }
        else
        {
            var mensajeError = await respuesta.ObtenerError();
            await JS.InvokeVoidAsync("alert", $"❌ Error: {mensajeError}");

            // // 🔍 Para depurar, muestra los datos enviados
            // Console.WriteLine($"Error al saldar venta #{venta.Id}");
            // Console.WriteLine($"Datos enviados: Total={ventaActualizada.Total}, Pagado={ventaActualizada.MontoPagado}, Saldo={ventaActualizada.SaldoPendiente}");
        }


    }

    private async Task EliminarVenta()
    {
        if (venta == null) return;

        var confirmado = await JS.InvokeAsync<bool>("confirm",
            $"¿ESTÁ SEGURO de eliminar la venta #{venta.Id}?\n\n" +
            $"Fecha: {venta.FechaVenta:dd/MM/yyyy}\n" +
            $"Cliente: {nombreCliente}\n" +
            $"Total: {venta.Total:C}\n\n" +
            $"⚠️ Esta acción NO se puede deshacer.");

        if (confirmado)
        {
            var respuesta = await VentaService.Delete(Id);
            if (!respuesta.Error)
            {
                await JS.InvokeVoidAsync("alert", "✅ Venta eliminada exitosamente");
                Navigation.NavigateTo("/ventas");
            }
            else
            {
                await JS.InvokeVoidAsync("alert", "❌ Error al eliminar la venta");
            }
        }
    }
}