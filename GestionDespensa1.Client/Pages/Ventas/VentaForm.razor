@page "/ventas/nuevo"
@page "/ventas/editar/{Id:int}"
@using GestionDespensa1.Shared.DTO
@using GestionDespensa1.Client.Servicios.Entidades
@inject IVentaService VentaService
@inject IClienteService ClienteService
@inject IProductoService ProductoService
@inject NavigationManager Navigation
@inject IJSRuntime JS

<PageTitle>@Titulo - GestionDespensa</PageTitle>

<div class="card">
    <div class="card-header bg-primary text-white">
        <h4 class="mb-0"><i class="bi @Icono me-2"></i>@Titulo</h4>
    </div>
    <div class="card-body">
        @if (clientesCargando || productosCargando)
        {
            <div class="alert alert-info text-center">
                <i class="bi bi-arrow-repeat spinner me-2"></i>Cargando datos...
            </div>
        }
        else if (!productosDisponibles.Any())
        {
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle me-2"></i>
                No hay productos disponibles.
                <a href="/productos/nuevo" class="alert-link">Crear un producto primero</a>
            </div>
        }
        else
        {
            <EditForm Model="venta" OnValidSubmit="GuardarVenta">
                <DataAnnotationsValidator />
                <ValidationSummary class="alert alert-danger" />

                <div class="row">
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="cliente" class="form-label fw-bold">Cliente</label>
                            <InputSelect id="cliente" @bind-Value="venta.IdCliente" class="form-control">
                                <option value="0">Cliente ocasional (Sin datos)</option>
                                @foreach (var cliente in clientes)
                                {
                                    <option value="@cliente.Id">@cliente.Nombre @cliente.Apellido - @cliente.Dni</option>
                                }
                            </InputSelect>
                            <div class="form-text text-muted">
                                Seleccione "Cliente ocasional" para ventas sin datos del cliente
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-group mb-3">
                            <label for="fecha" class="form-label fw-bold">Fecha Venta *</label>
                            <InputDate id="fecha" @bind-Value="venta.FechaVenta" class="form-control" />
                            <ValidationMessage For="@(() => venta.FechaVenta)" class="text-danger small" />
                        </div>
                    </div>
                </div>

                <div class="form-group mb-4">
                    <label class="form-label fw-bold">Productos *</label>

                    <div class="card">
                        <div class="card-body">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>PRODUCTO</th>
                                        <th>CANTIDAD</th>
                                        <th>PRECIO FINAL</th>
                                        <th>SUBTOTAL</th>
                                        <th>ACCIONES</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @if (!detallesVenta.Any())
                                    {
                                        <tr>
                                            <td colspan="5" class="text-center text-muted py-4">
                                                No hay productos añadidos. Haga clic en "Añadir producto" para comenzar.
                                            </td>
                                        </tr>
                                    }
                                    else
                                    {
                                        @foreach (var detalle in detallesVenta)
                                        {
                                            <tr>
                                                <td class="fw-bold">@detalle.DescripcionProducto</td>
                                                <td>@detalle.Cantidad</td>
                                                <td>$@detalle.PrecioUnitario.ToString("F2")</td>
                                                <td>$@((detalle.Cantidad * detalle.PrecioUnitario).ToString("F2"))</td>
                                                <td>
                                                    <button type="button" class="btn btn-sm btn-warning me-1"
                                                            @onclick="@(() => EditarDetalle(detalle))">
                                                        <i class="bi bi-pencil"></i>
                                                    </button>
                                                    <button type="button" class="btn btn-sm btn-danger"
                                                            @onclick="@(() => EliminarDetalle(detalle))">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    }
                                </tbody>
                            </table>

                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <button type="button" class="btn btn-success btn-sm me-2" @onclick="@MostrarModalProductoNuevo">
                                        <i class="bi bi-plus-circle me-1"></i> Producto Nuevo
                                    </button>
                                    <button type="button" class="btn btn-primary" @onclick="@MostrarModalProducto">
                                        <i class="bi bi-plus me-1"></i> Añadir Producto Existente
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-6 offset-md-6">
                        <div class="card bg-light">
                            <div class="card-body text-end">
                                <h5 class="mb-0">
                                    <strong>Total a Pagar: $@TotalVenta.ToString("F2")</strong>
                                </h5>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-group mb-4">
                    <label class="form-label fw-bold">Métodos de Pago</label>

                    <div class="card">
                        <div class="card-body">
                            <div class="row align-items-center mb-3">
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Efectivo:</label>
                                </div>
                                <div class="col-md-6">
                                    <input type="number"
                                           value="@pagoEfectivo"
                                           @oninput="@(e => OnPagoEfectivoChanged(e))"
                                           class="form-control" placeholder="0.00" step="0.01" min="0" />
                                </div>
                                <div class="col-md-3">
                                    <span class="badge bg-success fs-6">$@pagoEfectivo.ToString("F2")</span>
                                </div>
                            </div>

                            <div class="row align-items-center mb-3">
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Transferencia:</label>
                                </div>
                                <div class="col-md-6">
                                    <input type="number"
                                           value="@pagoTransferencia"
                                           @oninput="@(e => OnPagoTransferenciaChanged(e))"
                                           class="form-control" placeholder="0.00" step="0.01" min="0" />
                                </div>
                                <div class="col-md-3">
                                    <span class="badge bg-warning fs-6">$@pagoTransferencia.ToString("F2")</span>
                                </div>
                            </div>

                            <div class="row align-items-center mb-3">
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Débito / Crédito:</label>
                                </div>
                                <div class="col-md-6">
                                    <input type="number"
                                           value="@pagoTarjeta"
                                           @oninput="@(e => OnPagoTarjetaChanged(e))"
                                           class="form-control" placeholder="0.00" step="0.01" min="0" />
                                </div>
                                <div class="col-md-3">
                                    <span class="badge bg-info fs-6">$@pagoTarjeta.ToString("F2")</span>
                                </div>
                            </div>

                            <hr />

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="alert alert-success">
                                        <h6 class="mb-1">Total Pagado:</h6>
                                        <h4 class="mb-0">$@TotalPagado.ToString("F2")</h4>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="alert @(SaldoPendiente > 0 ? "alert-warning" : "alert-success")">
                                        <h6 class="mb-1">Saldo Pendiente:</h6>
                                        <h4 class="mb-0">$@SaldoPendiente.ToString("F2")</h4>
                                        @if (SaldoPendiente == 0 && TotalVenta > 0)
                                        {
                                            <small class="text-success">✅ Pago completo</small>
                                        }
                                        else if (SaldoPendiente > 0)
                                        {
                                            <small class="text-warning">⏳ Pago pendiente</small>
                                        }
                                    </div>
                                </div>
                            </div>

                            @if (SaldoPendiente > 0)
                            {
                                <div class="text-center mt-3">
                                    <button type="button" class="btn btn-success" @onclick="PagarTodo">
                                        <i class="bi bi-credit-card me-1"></i> Pagar Todo ($@SaldoPendiente.ToString("F2"))
                                    </button>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <input type="hidden" @bind="venta.Total" />
                <input type="hidden" @bind="venta.MontoPagado" />
                <input type="hidden" @bind="venta.SaldoPendiente" />
                <input type="hidden" @bind="venta.MetodoPago" />

                <div class="form-group mb-4">
                    <label for="estado" class="form-label fw-bold">Estado *</label>
                    <InputSelect id="estado" @bind-Value="venta.Estado" class="form-control">
                        <option value="Pendiente">Pendiente</option>
                        <option value="Pagado">Pagado</option>
                        <option value="Cancelado">Cancelado</option>
                    </InputSelect>
                    <ValidationMessage For="@(() => venta.Estado)" class="text-danger small" />
                </div>

                <div class="form-group mb-3">
                    <label for="notas" class="form-label fw-bold">Notas</label>
                    <textarea id="notas" @bind="venta.Notas" class="form-control" rows="3"
                              placeholder="Información adicional sobre esta venta..."></textarea>
                </div>

                <div class="form-group">
                    <button type="submit" class="btn btn-success me-2" disabled="@cargando">
                        <i class="bi @(cargando ? "bi-arrow-repeat spinner" : "bi-save") me-1"></i>
                        @(cargando ? "Guardando..." : "Guardar Venta")
                    </button>
                    <button type="button" class="btn btn-secondary me-2" @onclick="@Cancelar" disabled="@cargando">
                        <i class="bi bi-x me-1"></i> Cancelar
                    </button>
                    <a href="/clientes/nuevo" class="btn btn-outline-primary" target="_blank">
                        <i class="bi bi-plus me-1"></i> Nuevo Cliente
                    </a>
                </div>
            </EditForm>
        }
    </div>
</div>

<!-- Modal para productos existentes -->
@if (mostrarModalProducto)
{
    <div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">@(detalleEditando ? "Editar Producto" : "Añadir Producto Existente")</h5>
                    <button type="button" class="btn-close" @onclick="@CerrarModalProducto"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group mb-3">
                        <label class="form-label fw-bold">Producto *</label>
                        <div class="input-group">
                            <select value="@detalleSeleccionado.IdProducto"
                                    @onchange="@(e => OnProductoSeleccionadoChanged(e))"
                                    class="form-control">
                                <option value="0">Seleccione un producto</option>
                                @foreach (var producto in productosDisponibles)
                                {
                                    var precioFinal = CalcularPrecioFinal(producto.PrecioUnitario, producto.GananciaPorcentaje);
                                    <option value="@producto.Id">
                                        @producto.Descripcion - Stock: @producto.StockActual - Precio Final: $@precioFinal.ToString("F2")
                                    </option>
                                }
                            </select>
                            <button type="button" class="btn btn-outline-success" @onclick="@CambiarAModoProductoNuevo" title="Agregar producto nuevo">
                                <i class="bi bi-plus-lg"></i>
                            </button>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label fw-bold">Cantidad *</label>
                                <input type="number"
                                       value="@detalleSeleccionado.Cantidad"
                                       @oninput="@(e => OnCantidadDetalleChanged(e))"
                                       min="1" class="form-control" />
                                @if (detalleSeleccionado.IdProducto > 0)
                                {
                                    var producto = productosDisponibles.FirstOrDefault(p => p.Id == detalleSeleccionado.IdProducto);
                                    if (producto != null)
                                    {
                                        <small class="text-muted">Stock disponible: @producto.StockActual</small>
                                        @if (detalleSeleccionado.Cantidad > producto.StockActual)
                                        {
                                            <small class="text-danger d-block">¡Stock insuficiente!</small>
                                        }
                                    }
                                }
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label fw-bold">Precio Final *</label>
                                <input type="number"
                                       value="@detalleSeleccionado.PrecioUnitario"
                                       @oninput="@(e => OnPrecioDetalleChanged(e))"
                                       step="0.01" min="0" class="form-control" />
                                <small class="text-muted">Precio final calculado. Puede editarlo si es necesario.</small>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <strong>Subtotal: $@SubtotalModal.ToString("F2")</strong>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="@CerrarModalProducto">Cancelar</button>
                    <button type="button" class="btn btn-primary" @onclick="@AgregarDetalle" disabled="@(!PuedeAgregarProducto)">
                        @(detalleEditando ? "Actualizar" : "Añadir") Producto
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<!-- Modal para productos nuevos -->
@if (mostrarModalProductoNuevo)
{
    <div class="modal fade show" style="display: block; background-color: rgba(0,0,0,0.5);" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Añadir Producto Nuevo</h5>
                    <button type="button" class="btn-close" @onclick="@CerrarModalProductoNuevo"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group mb-3">
                        <label class="form-label fw-bold">Nombre del Producto *</label>
                        <input type="text" @bind="productoNuevoNombre" class="form-control"
                               placeholder="Ingrese el nombre del producto" />
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label fw-bold">Cantidad *</label>
                                <input type="number"
                                       value="@productoNuevoCantidad"
                                       @oninput="@(e => OnCantidadProductoNuevoChanged(e))"
                                       min="1" class="form-control" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group mb-3">
                                <label class="form-label fw-bold">Precio Final *</label>
                                <input type="number"
                                       value="@productoNuevoPrecio"
                                       @oninput="@(e => OnPrecioProductoNuevoChanged(e))"
                                       step="0.01" min="0" class="form-control" />
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info">
                        <strong>Subtotal: $@SubtotalProductoNuevo.ToString("F2")</strong>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" @onclick="@VolverAProductoExistente">Volver</button>
                    <button type="button" class="btn btn-success" @onclick="@AgregarProductoNuevo"
                            disabled="@(!PuedeAgregarProductoNuevo)">
                        <i class="bi bi-plus me-1"></i> Añadir Producto Nuevo
                    </button>
                </div>
            </div>
        </div>
    </div>
}

<style>
    .spinner {
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        from {
            transform: rotate(0deg);
        }

        to {
            transform: rotate(360deg);
        }
    }
</style>

@code {
    [Parameter] public int Id { get; set; }

    private VentaDTO venta = new()
    {
        FechaVenta = DateTime.Now,
        Estado = "Pendiente",
        Total = 0,
        MontoPagado = 0,
        SaldoPendiente = 0,
        MetodoPago = "Mixto",
        Notas = "",
        IdCliente = 0
    };

    private decimal pagoEfectivo = 0;
    private decimal pagoTransferencia = 0;
    private decimal pagoTarjeta = 0;

    private List<ClienteDTO> clientes = new();
    private List<ProductoDTO> productosDisponibles = new();
    private List<DetalleVentaDTO> detallesVenta = new();

    // Variables para el modal de productos existentes
    private bool mostrarModalProducto = false;
    private bool detalleEditando = false;
    private DetalleVentaDTO detalleSeleccionado = new();
    private DetalleVentaDTO? detalleOriginal = null;

    // Variables para el modal de productos nuevos
    private bool mostrarModalProductoNuevo = false;
    private string productoNuevoNombre = "";
    private int productoNuevoCantidad = 1;
    private decimal productoNuevoPrecio = 0;

    // Estados de carga
    private bool cargando = false;
    private bool clientesCargando = true;
    private bool productosCargando = true;

    // Propiedades computadas
    private string Titulo => Id == 0 ? "Nueva Venta" : "Editar Venta";
    private string Icono => Id == 0 ? "bi-plus" : "bi-pencil";
    private decimal TotalVenta => detallesVenta.Sum(p => p.Cantidad * p.PrecioUnitario);
    private decimal TotalPagado => pagoEfectivo + pagoTransferencia + pagoTarjeta;
    private decimal SaldoPendiente => TotalVenta - TotalPagado;
    private decimal SubtotalModal => detalleSeleccionado.Cantidad * detalleSeleccionado.PrecioUnitario;
    private decimal SubtotalProductoNuevo => productoNuevoCantidad * productoNuevoPrecio;
    private bool PuedeAgregarProducto => detalleSeleccionado.IdProducto > 0 &&
                                        detalleSeleccionado.Cantidad > 0 &&
                                        detalleSeleccionado.PrecioUnitario > 0 &&
                                        TieneStockSuficiente() &&
                                        SubtotalModal > 0;
    private bool PuedeAgregarProductoNuevo => !string.IsNullOrWhiteSpace(productoNuevoNombre) &&
                                             productoNuevoCantidad > 0 &&
                                             productoNuevoPrecio > 0;

    protected override async Task OnInitializedAsync()
    {
        await CargarClientes();
        await CargarProductos();

        if (Id > 0)
        {
            await CargarVenta();
        }
    }

    // Métodos auxiliares para parseo seguro sin ToString()
    private decimal ObtenerDecimal(object value)
    {
        return value switch
        {
            decimal decimalValue => decimalValue,
            int intValue => intValue,
            string stringValue when decimal.TryParse(stringValue, out decimal result) => result,
            _ => 0
        };
    }

    private int ObtenerInt(object value)
    {
        return value switch
        {
            int intValue => intValue,
            decimal decimalValue => (int)decimalValue,
            string stringValue when int.TryParse(stringValue, out int result) => result,
            _ => 0
        };
    }

    // Métodos simplificados para manejar cambios en los inputs
    private void OnPagoEfectivoChanged(ChangeEventArgs e)
    {
        pagoEfectivo = ObtenerDecimal(e.Value);
        OnPagoChanged();
    }

    private void OnPagoTransferenciaChanged(ChangeEventArgs e)
    {
        pagoTransferencia = ObtenerDecimal(e.Value);
        OnPagoChanged();
    }

    private void OnPagoTarjetaChanged(ChangeEventArgs e)
    {
        pagoTarjeta = ObtenerDecimal(e.Value);
        OnPagoChanged();
    }

    private void OnProductoSeleccionadoChanged(ChangeEventArgs e)
    {
        detalleSeleccionado.IdProducto = ObtenerInt(e.Value);
        OnProductoSeleccionadoChanged();
    }

    private void OnCantidadDetalleChanged(ChangeEventArgs e)
    {
        detalleSeleccionado.Cantidad = ObtenerInt(e.Value);
        StateHasChanged();
    }

    private void OnPrecioDetalleChanged(ChangeEventArgs e)
    {
        detalleSeleccionado.PrecioUnitario = ObtenerDecimal(e.Value);
        StateHasChanged();
    }

    private void OnCantidadProductoNuevoChanged(ChangeEventArgs e)
    {
        productoNuevoCantidad = ObtenerInt(e.Value);
        StateHasChanged();
    }

    private void OnPrecioProductoNuevoChanged(ChangeEventArgs e)
    {
        productoNuevoPrecio = ObtenerDecimal(e.Value);
        StateHasChanged();
    }

    private decimal CalcularPrecioFinal(decimal precioUnitario, decimal gananciaPorcentaje)
    {
        if (precioUnitario > 0 && gananciaPorcentaje >= 0)
        {
            decimal ganancia = precioUnitario * (gananciaPorcentaje / 100);
            return precioUnitario + ganancia;
        }
        return 0;
    }

    private async Task CargarClientes()
    {
        clientesCargando = true;
        var respuesta = await ClienteService.Get();

        if (!respuesta.Error)
        {
            clientes = respuesta.Respuesta ?? new List<ClienteDTO>();
        }

        clientesCargando = false;
        StateHasChanged();
    }

    private async Task CargarProductos()
    {
        productosCargando = true;
        var respuesta = await ProductoService.Get();

        if (!respuesta.Error)
        {
            productosDisponibles = respuesta.Respuesta ?? new List<ProductoDTO>();
        }

        productosCargando = false;
        StateHasChanged();
    }

    private async Task CargarVenta()
    {
        cargando = true;
        var respuesta = await VentaService.Get(Id);

        if (!respuesta.Error && respuesta.Respuesta != null)
        {
            venta = respuesta.Respuesta;
            // Cargar detalles de venta existentes
            detallesVenta = venta.DetallesVenta ?? new List<DetalleVentaDTO>();
            ActualizarTotales();
        }

        cargando = false;
        StateHasChanged();
    }

    private void MostrarModalProducto()
    {
        detalleEditando = false;
        detalleSeleccionado = new DetalleVentaDTO { Cantidad = 1, PrecioUnitario = 0 };
        mostrarModalProducto = true;
        StateHasChanged();
    }

    private void CerrarModalProducto()
    {
        mostrarModalProducto = false;
        detalleEditando = false;
        detalleOriginal = null;
        StateHasChanged();
    }

    private void MostrarModalProductoNuevo()
    {
        productoNuevoNombre = "";
        productoNuevoCantidad = 1;
        productoNuevoPrecio = 0;
        mostrarModalProductoNuevo = true;
        StateHasChanged();
    }

    private void CerrarModalProductoNuevo()
    {
        mostrarModalProductoNuevo = false;
        StateHasChanged();
    }

    private void CambiarAModoProductoNuevo()
    {
        mostrarModalProducto = false;
        MostrarModalProductoNuevo();
    }

    private void VolverAProductoExistente()
    {
        mostrarModalProductoNuevo = false;
        MostrarModalProducto();
    }

    private void OnProductoSeleccionadoChanged()
    {
        if (detalleSeleccionado.IdProducto > 0)
        {
            var producto = productosDisponibles.FirstOrDefault(p => p.Id == detalleSeleccionado.IdProducto);
            if (producto != null)
            {
                // Calcular y cargar automáticamente el precio final
                decimal precioFinal = CalcularPrecioFinal(producto.PrecioUnitario, producto.GananciaPorcentaje);
                detalleSeleccionado.PrecioUnitario = precioFinal;
                detalleSeleccionado.DescripcionProducto = producto.Descripcion;
                detalleSeleccionado.StockActual = producto.StockActual;

                StateHasChanged();
            }
        }
        else
        {
            // Si se selecciona "Seleccione un producto", limpiar los campos
            detalleSeleccionado.PrecioUnitario = 0;
            detalleSeleccionado.DescripcionProducto = "";
            detalleSeleccionado.StockActual = 0;
            StateHasChanged();
        }
    }

    private async Task OnPagoChanged()
    {
        await InvokeAsync(StateHasChanged);
        ActualizarPagos();
    }

    private void ActualizarPagos()
    {
        // Actualizar los campos de la venta
        venta.Total = TotalVenta;
        venta.MontoPagado = TotalPagado;
        venta.SaldoPendiente = SaldoPendiente;

        // Determinar método de pago
        var metodos = new List<string>();
        if (pagoEfectivo > 0) metodos.Add("Efectivo");
        if (pagoTransferencia > 0) metodos.Add("Transferencia");
        if (pagoTarjeta > 0) metodos.Add("Tarjeta");

        venta.MetodoPago = metodos.Count switch
        {
            0 => "No especificado",
            1 => metodos[0],
            _ => "Mixto"
        };

        // Actualizar estado si está pagado completamente
        if (SaldoPendiente <= 0 && TotalVenta > 0)
        {
            venta.Estado = "Pagado";
        }
        else if (TotalPagado > 0)
        {
            venta.Estado = "Parcial";
        }
        else
        {
            venta.Estado = "Pendiente";
        }

        StateHasChanged();
    }

    private void PagarTodo()
    {
        var saldoRestante = SaldoPendiente;

        // Distribuir el saldo pendiente entre los métodos de pago
        if (pagoEfectivo == 0 && pagoTransferencia == 0 && pagoTarjeta == 0)
        {
            // Si no hay pagos, poner todo en efectivo
            pagoEfectivo = saldoRestante;
        }
        else
        {
            // Distribuir proporcionalmente entre los métodos ya usados
            var totalActual = TotalPagado;
            if (totalActual > 0)
            {
                if (pagoEfectivo > 0) pagoEfectivo += (pagoEfectivo / totalActual) * saldoRestante;
                if (pagoTransferencia > 0) pagoTransferencia += (pagoTransferencia / totalActual) * saldoRestante;
                if (pagoTarjeta > 0) pagoTarjeta += (pagoTarjeta / totalActual) * saldoRestante;
            }
        }

        ActualizarPagos();
    }

    private bool TieneStockSuficiente()
    {
        if (detalleSeleccionado.IdProducto == 0) return true;

        var producto = productosDisponibles.FirstOrDefault(p => p.Id == detalleSeleccionado.IdProducto);
        return producto != null && detalleSeleccionado.Cantidad <= producto.StockActual;
    }

    private void AgregarDetalle()
    {
        if (detalleSeleccionado.IdProducto == 0)
        {
            JS.InvokeVoidAsync("alert", "Seleccione un producto");
            return;
        }

        if (detalleSeleccionado.Cantidad <= 0 || detalleSeleccionado.PrecioUnitario <= 0)
        {
            JS.InvokeVoidAsync("alert", "Cantidad y precio final deben ser mayores a 0");
            return;
        }

        // Validar stock
        if (!TieneStockSuficiente())
        {
            var producto = productosDisponibles.FirstOrDefault(p => p.Id == detalleSeleccionado.IdProducto);
            if (producto != null)
            {
                JS.InvokeVoidAsync("alert", $"Stock insuficiente. Stock disponible: {producto.StockActual}");
            }
            return;
        }

        // Obtener el nombre del producto seleccionado
        var productoSeleccionado = productosDisponibles.FirstOrDefault(p => p.Id == detalleSeleccionado.IdProducto);
        string nombreProducto = productoSeleccionado?.Descripcion ?? "Producto desconocido";

        if (detalleEditando && detalleOriginal != null)
        {
            // Reemplazar detalle existente
            var index = detallesVenta.IndexOf(detalleOriginal);
            if (index >= 0)
            {
                detallesVenta[index] = new DetalleVentaDTO
                {
                    IdProducto = detalleSeleccionado.IdProducto,
                    DescripcionProducto = nombreProducto,
                    Cantidad = detalleSeleccionado.Cantidad,
                    PrecioUnitario = detalleSeleccionado.PrecioUnitario,
                    StockActual = detalleSeleccionado.StockActual
                };
            }
        }
        else
        {
            // Agregar nuevo detalle
            detallesVenta.Add(new DetalleVentaDTO
            {
                IdProducto = detalleSeleccionado.IdProducto,
                DescripcionProducto = nombreProducto,
                Cantidad = detalleSeleccionado.Cantidad,
                PrecioUnitario = detalleSeleccionado.PrecioUnitario,
                StockActual = detalleSeleccionado.StockActual
            });
        }

        ActualizarTotales();
        CerrarModalProducto();
    }

    private void AgregarProductoNuevo()
    {
        if (string.IsNullOrWhiteSpace(productoNuevoNombre))
        {
            JS.InvokeVoidAsync("alert", "Ingrese el nombre del producto");
            return;
        }

        if (productoNuevoCantidad <= 0 || productoNuevoPrecio <= 0)
        {
            JS.InvokeVoidAsync("alert", "Cantidad y precio deben ser mayores a 0");
            return;
        }

        // Agregar producto nuevo (IdProducto = 0 indica que no está en el catálogo)
        detallesVenta.Add(new DetalleVentaDTO
        {
            IdProducto = 0, // 0 indica producto no catalogado
            DescripcionProducto = productoNuevoNombre.Trim(),
            Cantidad = productoNuevoCantidad,
            PrecioUnitario = productoNuevoPrecio,
            StockActual = 0 // No aplica para productos nuevos
        });

        ActualizarTotales();
        CerrarModalProductoNuevo();
    }

    private void EditarDetalle(DetalleVentaDTO detalle)
    {
        detalleEditando = true;
        detalleOriginal = detalle;
        detalleSeleccionado = new DetalleVentaDTO
        {
            IdProducto = detalle.IdProducto,
            DescripcionProducto = detalle.DescripcionProducto,
            Cantidad = detalle.Cantidad,
            PrecioUnitario = detalle.PrecioUnitario,
            StockActual = detalle.StockActual
        };
        mostrarModalProducto = true;
        StateHasChanged();
    }

    private void EliminarDetalle(DetalleVentaDTO detalle)
    {
        detallesVenta.Remove(detalle);
        ActualizarTotales();
        StateHasChanged();
    }

    private void ActualizarTotales()
    {
        venta.Total = TotalVenta;
        ActualizarPagos();
    }

    private async Task GuardarVenta()
    {
        cargando = true;
        StateHasChanged();

        if (!detallesVenta.Any())
        {
            await JS.InvokeVoidAsync("alert", "Debe añadir al menos un producto a la venta.");
            cargando = false;
            StateHasChanged();
            return;
        }

        // Si no hay cliente seleccionado (IdCliente = 0), se guarda como cliente ocasional
        if (venta.IdCliente == 0)
        {
            if (string.IsNullOrEmpty(venta.Notas))
            {
                venta.Notas = "Cliente ocasional";
            }
            else if (!venta.Notas.Contains("Cliente ocasional"))
            {
                venta.Notas += " | Cliente ocasional";
            }
        }

        // Preparar detalles de pago para guardar en notas
        var detallesPago = $"PAGOS: Efectivo: ${pagoEfectivo:F2} | Transferencia: ${pagoTransferencia:F2} | Tarjeta: ${pagoTarjeta:F2}";
        venta.Notas = string.IsNullOrEmpty(venta.Notas) ? detallesPago : $"{venta.Notas}\n{detallesPago}";

        if (Id == 0)
        {
            var crearVenta = new CrearVentaDTO
            {
                IdCliente = venta.IdCliente,
                FechaVenta = venta.FechaVenta,
                Estado = venta.Estado,
                Total = venta.Total,
                MontoPagado = venta.MontoPagado,
                SaldoPendiente = venta.SaldoPendiente,
                MetodoPago = venta.MetodoPago,
                Notas = venta.Notas,
                DetallesVenta = detallesVenta
            };

            var respuesta = await VentaService.Insert(crearVenta);
            if (!respuesta.Error && respuesta.Respuesta > 0)
            {
                await JS.InvokeVoidAsync("alert", "✅ Venta creada exitosamente");
                Navigation.NavigateTo("/ventas");
            }
            else
            {
                await JS.InvokeVoidAsync("alert", $"❌ Error: {await respuesta.ObtenerError()}");
            }
        }
        else
        {
            venta.DetallesVenta = detallesVenta;
            var respuesta = await VentaService.Update(Id, venta);
            if (!respuesta.Error)
            {
                await JS.InvokeVoidAsync("alert", "✅ Venta actualizada exitosamente");
                Navigation.NavigateTo("/ventas");
            }
            else
            {
                await JS.InvokeVoidAsync("alert", $"❌ Error: {await respuesta.ObtenerError()}");
            }
        }

        cargando = false;
        StateHasChanged();
    }

    private void Cancelar() => Navigation.NavigateTo("/ventas");
}